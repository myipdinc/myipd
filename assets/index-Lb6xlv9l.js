import{C as yt,M as Ht,P as Mt,a as C,S as It,b as Pt,W as Et,c as zt,D as Wt,A as _t,B as Yt,d as z,G as kt,e as Xt,f as Gt,V as Nt}from"./three-CseG-3LM.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();let ht=0,lt=null;function ct(o=1,t=.5,e=1){return o+t*Math.sin(Date.now()/1e3*e)}const at=.064;function Vt(o=1){const t=Date.now(),e=1e3/o;if(t-ht>=e){ht=t;const i=7e-4/2;lt={left:{x:ct(at/2,i,1),y:0},right:{x:-ct(-at/2,i,1),y:0}}}return lt}class I{constructor(t=.01){this.min=1/0,this.max=-1/0,this.minValidRange=t}add(t){if(this.min===1/0||this.max===-1/0){this.min=t,this.max=t;return}this.min=Math.min(this.min,t),this.max=Math.max(this.max,t)}getNormalized(t){this.add(t);const e=this.max-this.min;if(e<this.minValidRange)return console.log("range < minValidRange:",e.toFixed(6),this.minValidRange),0;const i=(this.min+this.max)/2;return 2*(t-i)/e}getAll(){const t=this.max-this.min;return{min:this.min,max:this.max,center:(this.min+this.max)/2,range:t,hasValidRange:t>=this.minValidRange}}reset(){this.min=1/0,this.max=-1/0}}class Bt{constructor(){const t=document.createElement("div");t.style.position="absolute",t.style.top="10px",t.style.left="10px",t.style.color="white",t.style.fontFamily="monospace",t.style.fontSize="24px";const e=document.createElement("div"),i=document.createElement("div");i.style.fontSize="18px";const s=document.createElement("div");s.style.fontSize="12px",t.appendChild(e),t.appendChild(i),document.body.appendChild(t),this.textDiv=e,this.textDivLR=i,this.textDivMinMaxLR=s}update(t,e,i,s,n,r,h){this.textDiv.innerHTML="IPD: "+t+"mm",this.textDivLR.innerHTML="L: "+e+" R: "+i,this.textDivMinMaxLR.innerHTML=`[${s},${n}] [${r},${h}]`}}class Ft{constructor(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=600,this.canvas.height=600,this.W=600,this.H=600,this.cornerRadius=20;const i="rgba(255, 255, 255, 1) ";this.bgColor=i,this.clearCanvas(),this.ctx.textAlign="center",this.ctx.textBaseline="middle";const s=new yt(this.canvas),n=new Ht({map:s,transparent:!0,opacity:1}),r=new Mt(1,600/600);this.mesh=new C(r,n),this.texture=s,this.lineParams=[{y:80,fontSize:68},{y:180,fontSize:48},{y:260,fontSize:32},{y:300,fontSize:24}]}drawRoundedRect(t,e,i,s,n){const r=this.ctx;r.beginPath(),r.moveTo(t+n,e),r.lineTo(t+i-n,e),r.quadraticCurveTo(t+i,e,t+i,e+n),r.lineTo(t+i,e+s-n),r.quadraticCurveTo(t+i,e+s,t+i-n,e+s),r.lineTo(t+n,e+s),r.quadraticCurveTo(t,e+s,t,e+s-n),r.lineTo(t,e+n),r.quadraticCurveTo(t,e,t+n,e),r.closePath()}clearCanvas(){this.ctx.clearRect(0,0,this.W,this.H)}drawLayout(t){const e=this.ctx,i=this.W,s=this.H;if(e.save(),e.fillStyle=this.bgColor,this.drawRoundedRect(0,0,i,s,this.cornerRadius),e.fill(),e.fillStyle="black",e.font="28px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText("IPD",i/2,40),e.font="82px monospace",e.fillText(`${t.ipd}mm`,i/2,110),e.font="28px monospace",e.fillText("LEFT",i*.25,180),e.fillText("RIGHT",i*.75,180),e.font="48px monospace",e.fillText(t.left,i*.25,230),e.fillText(t.right,i*.75,230),e.font="24px monospace",e.fillStyle="black",e.textAlign="center",e.fillText(`${t.leftMin},${t.leftMax}`,i*.25,390),e.font="18px monospace",e.fillText("MIN, MAX",i*.25,415),e.font="24px monospace",e.fillText(t.leftRange,i*.25,450),e.font="18px monospace",e.fillText("RANGE",i*.25,475),e.font="24px monospace",e.fillText(`${t.rightMin},${t.rightMax}`,i*.75,390),e.font="18px monospace",e.fillText("MIN, MAX",i*.75,415),e.font="24px monospace",e.fillText(t.rightRange,i*.75,450),e.font="18px monospace",e.fillText("RANGE",i*.75,475),t.showMessage){const n="< Move eyes left and right >";e.font="26px monospace",e.textAlign="center",e.fillText(n,i/2,s-75)}e.font="28px monospace",e.textAlign="right",e.fillText(`myIPD v${t.version}`,i-20,s-30),e.restore()}update(t,e="center"){this.clearCanvas(),this.drawLayout(t),this.ctx.fillStyle="rgba(255, 255, 0, 1)";const i=25;switch(e){case"left":this.drawRoundedRect(0,0,i,this.H,this.cornerRadius),this.ctx.fill();break;case"right":this.drawRoundedRect(this.W-i,0,i,this.H,this.cornerRadius),this.ctx.fill();break;case"top":this.drawRoundedRect(0,0,this.W,i,this.cornerRadius),this.ctx.fill();break;case"bottom":this.drawRoundedRect(0,this.H-i,this.W,i,this.cornerRadius),this.ctx.fill();break}this.texture.needsUpdate=!0}}class dt{constructor(t,e,i,s=-1,n=1){this.ctx=t,this.width=e,this.height=i,this.minY=s,this.maxY=n,this.x=0,this.y=0,this.dotRadius=3,this.dotColor="blue",this.borderColor="#000000",this.borderWidth=3,this.axisColor="#000000",this.axisWidth=3,this.threshold=null,this.aboveThresholdColor="rgba(255, 200, 200, 0.3)",this.belowThresholdColor="rgba(255, 255, 255, 0.3)",this.showBothSides=!0}position(t,e){return this.x=t,this.y=e,this}_mapValueToY(t){const e=(t-this.minY)/(this.maxY-this.minY);return this.y+this.height-e*this.height}_drawBorder(){const t=this.ctx;t.save(),t.strokeStyle=this.borderColor,t.lineWidth=this.borderWidth,t.strokeRect(this.x,this.y,this.width,this.height),t.restore()}_drawXAxis(){const t=this.ctx;t.save();const e=this._mapValueToY(0);t.strokeStyle=this.axisColor,t.lineWidth=this.axisWidth,t.beginPath(),t.moveTo(this.x,e),t.lineTo(this.x+this.width,e),t.stroke(),t.restore()}setThreshold(t,e=null,i=null){return this.threshold=t,e&&(this.aboveThresholdColor=e),i&&(this.belowThresholdColor=i),this}draw(t){if(!t||t.length===0)return this;if(this.threshold!==null){const s=this._mapValueToY(this.threshold);if(this.ctx.save(),this.ctx.fillStyle=this.aboveThresholdColor,this.ctx.fillRect(this.x,this.y,this.width,s-this.y),this.ctx.restore(),this.ctx.save(),this.ctx.strokeStyle="rgb(0, 0, 0)",this.ctx.lineWidth=1,this.ctx.setLineDash([5,3]),this.ctx.beginPath(),this.ctx.moveTo(this.x,s),this.ctx.lineTo(this.x+this.width,s),this.ctx.stroke(),this.ctx.restore(),this.showBothSides){const n=this._mapValueToY(-this.threshold);this.ctx.save(),this.ctx.fillStyle=this.aboveThresholdColor,this.ctx.fillRect(this.x,n,this.width,this.y+this.height-n),this.ctx.restore(),this.ctx.save(),this.ctx.strokeStyle="rgb(0, 0, 0)",this.ctx.lineWidth=1,this.ctx.setLineDash([5,3]),this.ctx.beginPath(),this.ctx.moveTo(this.x,n),this.ctx.lineTo(this.x+this.width,n),this.ctx.stroke(),this.ctx.restore()}else this.ctx.save(),this.ctx.fillStyle=this.belowThresholdColor,this.ctx.fillRect(this.x,s,this.width,this.y+this.height-s),this.ctx.restore()}this._drawXAxis();const e=t.length,i=this.width/e;this.ctx.save(),this.ctx.strokeStyle=this.dotColor,this.ctx.lineWidth=2,this.ctx.beginPath();for(let s=0;s<e;s++){const n=t[s],r=this.x+s*i+i/2,h=this._mapValueToY(n);s===0?this.ctx.moveTo(r,h):this.ctx.lineTo(r,h)}this.ctx.stroke(),this.ctx.restore(),this.ctx.fillStyle=this.dotColor,this._drawBorder();for(let s=0;s<e;s++){const n=t[s],r=this.x+s*i+i/2,h=this._mapValueToY(n);this.ctx.beginPath(),this.ctx.arc(r,h,this.dotRadius,0,Math.PI*2),this.ctx.fill()}return this}setDotStyle(t,e){return this.dotRadius=t,this.dotColor=e,this}setBorderStyle(t,e=1){return this.borderColor=t,this.borderWidth=e,this}setAxisStyle(t,e=1){return this.axisColor=t,this.axisWidth=e,this}}const Ot=1e3,$t=1/Ot,P=.7*$t/2,Tt=P/2,F=.5,xt=1,ft=1,q=1,j=-1,Rt=0;let O=!1,f,L;const b=new I(P),W=new I(P),$=new I(Tt),U=new I(Tt),K=new I(P),G=2e3,A=Array(G).fill(0),D=Array(G).fill(0),_=Array(G).fill(0),Y=Array(G).fill(0),mt=10;let k=0,T=0,R=0,V=0,B=0,H=0;function Ut(o){switch(o){case q:return"left";case j:return"right";case Rt:default:return"center"}}let v,y,vt,g,w,m,u;const X=13421789,ut=16737894;function pt(o){const t=document.createElement("canvas"),e=t.getContext("2d");t.width=1024,t.height=512,e.fillStyle="#ccccdd",e.fillRect(0,0,t.width,t.height),e.fillStyle="#000000",e.font="bold 150px Arial",e.textAlign="center",e.textBaseline="middle",e.fillText(o,t.width/2,t.height/2);const i=new yt(t);return i.encoding=Gt,i}const S=new It;S.background=new Pt(0);const l=new Et({antialias:!0});l.xr.enabled=!0;l.setSize(window.innerWidth,window.innerHeight);document.body.appendChild(l.domElement);const bt=60,a=new zt(bt,window.innerWidth/window.innerHeight,.1,100);S.add(a);function qt(){const o=new Wt(16777215,1);o.position.set(0,0,1),S.add(o);const t=new _t(16777215,.4);S.add(t);const e=new Yt(1,1,1),i=new z({color:65280});v=new C(e,i),v.position.z=-3,v.visible=!1,S.add(v);const s=new Mt(100,100),n=new z({color:10066329}),r=new C(s,n);r.rotation.x=-Math.PI/2;const h=-1.2,d=2,M=.25,x=new kt;x.position.z=-d;const p=Math.PI/180,E=new Xt(M,44,36),N=new z({color:X,map:pt("L")});m=new C(E,N),m.position.x=h,m.rotation.y=p*-60,x.add(m);const At=E.clone(),Dt=new z({color:X,map:pt("R")});u=new C(At,Dt),u.rotation.y=p*-120,u.position.x=-h,x.add(u),a.add(x),y=new Ft,y.mesh.position.z=-d,a.add(y.mesh),vt=new Bt;const Z=1,tt="rgba(0, 0, 0, 1)",et=2,it="#333333",st=2,ot=100,nt=220,rt=260;g=new dt(y.ctx,nt,ot),g.position(40,rt),g.setDotStyle(Z,"red"),g.setBorderStyle(tt,et),g.setAxisStyle(it,st),g.setThreshold(1-F,"rgba(255, 200, 200, 0.3)"),w=new dt(y.ctx,nt,ot),w.position(340,rt),w.setDotStyle(Z,"blue"),w.setBorderStyle(tt,et),w.setAxisStyle(it,st),w.setThreshold(1-F,"rgba(200, 200, 255, 0.3)"),Ct(),St()}function St(){const o=gt(A,mt);g.draw(o);const t=gt(D,mt);w.draw(t),A[A.length-1],_[_.length-1],D[D.length-1],Y[Y.length-1],y.texture.needsUpdate=!0}function gt(o,t){const e=[];for(let i=0;i<o.length;i+=t)e.push(o[i]);return e}function c(o){return o===1/0||o===-1/0?0 .toFixed(2):(o*1e3).toFixed(2)}function Ct(){const o=b.getAll(),t=W.getAll();K.getAll();const e=c(k),i=c(T),s=c(R),n=c(o.min),r=c(o.max),h=c(t.min),d=c(t.max),M=c(o.max-o.min),x=c(t.max-t.min),p=Ut(H),E=b.max-b.min<P;let N={ipd:e,left:i,right:s,leftMin:n,leftMax:r,rightMin:h,rightMax:d,leftRange:M,rightRange:x,version:"1.0",showMessage:E};y.update(N,p),vt.update(e,i,s,n,r,h,d)}qt();const Lt=Nt.createButton(l);document.body.appendChild(Lt);window.addEventListener("resize",J);function J(){l.xr.isPresenting||(l.setSize(window.innerWidth,window.innerHeight),a.aspect=window.innerWidth/window.innerHeight,a.updateProjectionMatrix())}document.addEventListener("keydown",o=>{o.code==="Escape"?f&&f.end():o.code==="KeyM"?O=!O:o.code==="Enter"?Lt.click():o.code==="KeyR"&&Q()});function jt(){Q(),a.fov=bt,a.position.set(0,0,0),a.updateProjectionMatrix(),J()}let wt=0;function Kt(o,t){const e=o-wt;wt=o,v.rotation.x+=.001*e,v.rotation.y+=3e-4*e,t&&L&&(Zt(t),Ct(),Qt()),St()}function Jt(o,t){l.xr.isPresenting?(f===null&&(f=l.xr.getSession(),f.addEventListener("end",jt),f.addEventListener("select",()=>{console.log("WebXR select event detected"),Q()})),L===null&&f.requestReferenceSpace("viewer").then(e=>{L=e})):(f=null,L=null),l.render(S,a),Kt(o,t)}function Q(){console.log("reset"),b.reset(),W.reset(),$.reset(),U.reset(),K.reset(),k=0,T=0,R=0,J()}function Qt(){m.material.color.setHex(X),u.material.color.setHex(X),m.scale.set(1,1,1),u.scale.set(1,1,1);const o=1.2;switch(H){case q:m.material.color.setHex(ut),m.scale.set(o,o,o);break;case j:u.material.color.setHex(ut),u.scale.set(o,o,o);break}}function Zt(o){const t=o.getViewerPose(L);if(t)if(t.views.length===2){const e=t.views[0],i=t.views[1];let s=e.transform.position,n=i.transform.position;if(O){const p=Vt(100);s=p.left,n=p.right}T=Math.abs(s.x)*xt,R=Math.abs(n.x)*ft,V=Math.abs(s.y)*xt,B=Math.abs(n.y)*ft,k=T+R,b.add(T),W.add(R),$.add(V),U.add(B),K.add(k);const r=b.getNormalized(T);console.log("normalizedLeftX:",r.toFixed(5));const h=W.getNormalized(R);console.log("normalizedRightX:",h.toFixed(5)),A.shift(),A.push(r),D.shift(),D.push(h);const d=$.getNormalized(V);console.log("normalizedLeftY:",d.toFixed(5));const M=U.getNormalized(B);console.log("normalizedRightY:",M.toFixed(5)),_.shift(),_.push(d),Y.shift(),Y.push(M);const x=1-F;Math.abs(r)>x?H=r>0?q:j:H=Rt,console.log("eyeDirection:",H)}else console.log("views length should be 2")}l.setAnimationLoop(Jt);
